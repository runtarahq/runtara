name: Release

on:
    push:
        tags:
            - "v[0-9]+.[0-9]+.[0-9]+"
            - "v[0-9]+.[0-9]+.[0-9]+-*"

permissions:
    contents: write

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1
    SQLX_OFFLINE: true

jobs:
    release:
        name: Build and Release
        runs-on: ubuntu-latest

        steps:
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1

            - name: Build release binaries
              run: cargo build --release -p runtara-core -p runtara-environment

            - name: Strip binaries
              run: |
                  strip target/release/runtara-core
                  strip target/release/runtara-environment

            - name: Create tarballs
              run: |
                  cd target/release
                  tar czf runtara-core-${{ steps.get_version.outputs.version }}-x86_64-linux.tar.gz runtara-core
                  tar czf runtara-environment-${{ steps.get_version.outputs.version }}-x86_64-linux.tar.gz runtara-environment

            - name: Build DEB packages
              env:
                  VERSION: ${{ steps.get_version.outputs.version }}
              run: |
                  ./scripts/build-deb.sh runtara-core
                  ./scripts/build-deb.sh runtara-environment

            - name: Create GitHub Release and upload assets
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  VERSION="${{ steps.get_version.outputs.version }}"
                  TAG="${{ github.ref_name }}"

                  # Determine if prerelease
                  PRERELEASE_FLAG=""
                  if [[ "$TAG" == *-* ]]; then
                      PRERELEASE_FLAG="--prerelease"
                  fi

                  # Create release with assets
                  gh release create "$TAG" \
                      --title "Release $VERSION" \
                      $PRERELEASE_FLAG \
                      target/release/runtara-core-${VERSION}-x86_64-linux.tar.gz \
                      target/release/runtara-environment-${VERSION}-x86_64-linux.tar.gz \
                      target/runtara-core_${VERSION}_amd64.deb \
                      target/runtara-environment_${VERSION}_amd64.deb

    # Publish crates in dependency order as separate jobs for retry capability
    # Layer 1: No internal dependencies
    publish-dsl:
        name: Publish runtara-dsl
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-dsl --allow-dirty

    publish-agent-macro:
        name: Publish runtara-agent-macro
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-agent-macro --allow-dirty

    publish-protocol:
        name: Publish runtara-protocol
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-protocol --allow-dirty

    publish-sdk-macros:
        name: Publish runtara-sdk-macros
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-sdk-macros --allow-dirty

    # Layer 2: Depend on layer 1
    publish-agents:
        name: Publish runtara-agents
        runs-on: ubuntu-latest
        needs: [publish-dsl, publish-agent-macro]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Wait for crates.io index
              run: sleep 30
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-agents --allow-dirty

    publish-sdk:
        name: Publish runtara-sdk
        runs-on: ubuntu-latest
        needs: [publish-protocol, publish-sdk-macros]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Wait for crates.io index
              run: sleep 30
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-sdk --allow-dirty

    publish-workflows:
        name: Publish runtara-workflows
        runs-on: ubuntu-latest
        needs: [publish-dsl]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Wait for crates.io index
              run: sleep 30
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-workflows --allow-dirty

    # Layer 3: Depend on layer 2
    publish-workflow-stdlib:
        name: Publish runtara-workflow-stdlib
        runs-on: ubuntu-latest
        needs: [publish-agents, publish-sdk]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Wait for crates.io index
              run: sleep 30
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-workflow-stdlib --allow-dirty

    publish-management-sdk:
        name: Publish runtara-management-sdk
        runs-on: ubuntu-latest
        needs: [publish-protocol]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}
            - name: Wait for crates.io index
              run: sleep 30
            - name: Publish
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish -p runtara-management-sdk --allow-dirty
