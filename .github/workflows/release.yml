name: Release

on:
    push:
        tags:
            - "v[0-9]+.[0-9]+.[0-9]+"
            - "v[0-9]+.[0-9]+.[0-9]+-*"

permissions:
    contents: write

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1
    SQLX_OFFLINE: true

jobs:
    release:
        name: Build and Release
        runs-on: ubuntu-latest

        steps:
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1

            - name: Build release binaries
              run: cargo build --release -p runtara-core -p runtara-environment

            - name: Strip binaries
              run: |
                  strip target/release/runtara-core
                  strip target/release/runtara-environment

            - name: Create tarballs
              run: |
                  cd target/release
                  tar czf runtara-core-${{ steps.get_version.outputs.version }}-x86_64-linux.tar.gz runtara-core
                  tar czf runtara-environment-${{ steps.get_version.outputs.version }}-x86_64-linux.tar.gz runtara-environment

            - name: Build DEB packages
              env:
                  VERSION: ${{ steps.get_version.outputs.version }}
              run: |
                  ./scripts/build-deb.sh runtara-core
                  ./scripts/build-deb.sh runtara-environment

            - name: Create GitHub Release and upload assets
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  VERSION="${{ steps.get_version.outputs.version }}"
                  TAG="${{ github.ref_name }}"

                  # Determine if prerelease
                  PRERELEASE_FLAG=""
                  if [[ "$TAG" == *-* ]]; then
                      PRERELEASE_FLAG="--prerelease"
                  fi

                  # Create release with assets
                  gh release create "$TAG" \
                      --title "Release $VERSION" \
                      $PRERELEASE_FLAG \
                      target/release/runtara-core-${VERSION}-x86_64-linux.tar.gz \
                      target/release/runtara-environment-${VERSION}-x86_64-linux.tar.gz \
                      target/runtara-core_${VERSION}_amd64.deb \
                      target/runtara-environment_${VERSION}_amd64.deb

    publish-crates:
        name: Publish to crates.io
        runs-on: ubuntu-latest

        steps:
            - name: Get version from tag
              id: get_version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install protoc
              run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

            - name: Setup Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1

            - name: Update versions from tag
              run: ./scripts/update-version.sh ${{ steps.get_version.outputs.version }}

            - name: Publish crates to crates.io
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: |
                  # Publish in dependency order with delays for crates.io index updates
                  # Layer 1: No internal dependencies
                  echo "Publishing runtara-dsl..."
                  cargo publish -p runtara-dsl --allow-dirty
                  sleep 30

                  echo "Publishing runtara-agent-macro..."
                  cargo publish -p runtara-agent-macro --allow-dirty
                  sleep 30

                  echo "Publishing runtara-protocol..."
                  cargo publish -p runtara-protocol --allow-dirty
                  sleep 30

                  echo "Publishing runtara-sdk-macros..."
                  cargo publish -p runtara-sdk-macros --allow-dirty
                  sleep 30

                  # Layer 2: Depend on layer 1
                  echo "Publishing runtara-agents..."
                  cargo publish -p runtara-agents --allow-dirty
                  sleep 30

                  echo "Publishing runtara-sdk..."
                  cargo publish -p runtara-sdk --allow-dirty
                  sleep 30

                  echo "Publishing runtara-workflows..."
                  cargo publish -p runtara-workflows --allow-dirty
                  sleep 30

                  # Layer 3: Depend on layer 2
                  echo "Publishing runtara-workflow-stdlib..."
                  cargo publish -p runtara-workflow-stdlib --allow-dirty
                  sleep 30

                  echo "Publishing runtara-management-sdk..."
                  cargo publish -p runtara-management-sdk --allow-dirty

                  echo "All crates published successfully!"
