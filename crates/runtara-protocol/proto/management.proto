syntax = "proto3";
package runtara.management;

// ============================================================================
// Management Protocol - Internal (runtara-environment ↔ runtara-core)
//
// Only runtara-environment should talk to this protocol. External lifecycle
// operations (start/stop/register image) live in environment.proto.
// ============================================================================

// ============================================================================
// Health Check
// ============================================================================

message HealthCheckRequest {}

message HealthCheckResponse {
  bool healthy = 1;
  string version = 2;
  int64 uptime_ms = 3;
  uint32 active_instances = 4;
}

// ============================================================================
// Send Signal to Instance (environment → core → instance)
// ============================================================================

enum SignalType {
  SIGNAL_CANCEL = 0;      // Cancel execution
  SIGNAL_PAUSE = 1;       // Pause execution (checkpoint and wait)
  SIGNAL_RESUME = 2;      // Resume paused execution
}

// Environment requests core to send a signal to an instance
message SendSignalRequest {
  string instance_id = 1;
  SignalType signal_type = 2;
  bytes payload = 3;            // Signal-specific data (e.g., cancel reason)
}

message SendSignalResponse {
  bool success = 1;
  string error = 2;             // Error if instance not found, not connected, etc.
}

// ============================================================================
// Instance Status Query (environment can query any instance)
// ============================================================================

message GetInstanceStatusRequest {
  string instance_id = 1;
}

message GetInstanceStatusResponse {
  string instance_id = 1;
  InstanceStatus status = 2;
  optional string checkpoint_id = 3;  // Last known checkpoint
  int64 started_at_ms = 4;
  optional int64 finished_at_ms = 5;
  optional bytes output = 6;          // If completed
  optional string error = 7;          // If failed
}

enum InstanceStatus {
  STATUS_UNKNOWN = 0;
  STATUS_PENDING = 1;     // Queued, not yet started
  STATUS_RUNNING = 2;     // Currently executing
  STATUS_SUSPENDED = 3;   // Sleeping / waiting for wake
  STATUS_COMPLETED = 4;   // Finished successfully
  STATUS_FAILED = 5;      // Finished with error
  STATUS_CANCELLED = 6;   // Cancelled by signal
}

// ============================================================================
// List Instances
// ============================================================================

message ListInstancesRequest {
  optional string tenant_id = 1;      // Filter by tenant
  optional InstanceStatus status = 2; // Filter by status
  uint32 limit = 3;                   // Max results (default: 100)
  uint32 offset = 4;                  // Pagination offset
}

message ListInstancesResponse {
  repeated InstanceSummary instances = 1;
  uint32 total_count = 2;
}

message InstanceSummary {
  string instance_id = 1;
  string tenant_id = 2;
  InstanceStatus status = 3;
  int64 created_at_ms = 4;
}

// ============================================================================
// Checkpoints
// ============================================================================

// List checkpoints for an instance
message ListCheckpointsRequest {
  string instance_id = 1;
  optional string checkpoint_id = 2;  // Filter by checkpoint_id
  optional uint32 limit = 3;          // Max results (default: 100)
  optional uint32 offset = 4;         // Pagination offset
  optional int64 created_after_ms = 5;  // Filter checkpoints created after this time
  optional int64 created_before_ms = 6; // Filter checkpoints created before this time
}

message ListCheckpointsResponse {
  repeated CheckpointSummary checkpoints = 1;
  uint32 total_count = 2;
  uint32 limit = 3;
  uint32 offset = 4;
}

message CheckpointSummary {
  string checkpoint_id = 1;
  string instance_id = 2;
  int64 created_at_ms = 3;
  uint64 data_size_bytes = 4;         // Size of checkpoint data in bytes
}

// Get full checkpoint data
message GetCheckpointRequest {
  string instance_id = 1;
  string checkpoint_id = 2;
}

message GetCheckpointResponse {
  bool found = 1;
  string checkpoint_id = 2;
  string instance_id = 3;
  int64 created_at_ms = 4;
  bytes data = 5;                     // Checkpoint state data (JSON bytes)
}

// ============================================================================
// RPC Wrapper (for multiplexing on single stream)
// ============================================================================

// Wrapper for all management request types
message RpcRequest {
  oneof request {
    HealthCheckRequest health_check = 1;
    SendSignalRequest send_signal = 2;
    GetInstanceStatusRequest get_instance_status = 3;
    ListInstancesRequest list_instances = 4;
    // Checkpoints
    ListCheckpointsRequest list_checkpoints = 9;
    GetCheckpointRequest get_checkpoint = 10;
  }
}

// Wrapper for all management response types
message RpcResponse {
  oneof response {
    HealthCheckResponse health_check = 1;
    SendSignalResponse send_signal = 2;
    GetInstanceStatusResponse get_instance_status = 3;
    ListInstancesResponse list_instances = 4;
    RpcError error = 15;
    // Checkpoints
    ListCheckpointsResponse list_checkpoints = 9;
    GetCheckpointResponse get_checkpoint = 10;
  }
}

// Generic RPC error
message RpcError {
  string code = 1;
  string message = 2;
}
